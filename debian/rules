#!/usr/bin/make -f

# Uncomment this to turn on verbose mode. 
#export DH_VERBOSE=1

DEB_HOST_ARCH       ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)
DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

SOURCE := $(shell dpkg-parsechangelog | sed -ne 's,^Source: *\(.*\)$$,\1,p')
VERSION_COMPLETE := $(shell dpkg-parsechangelog | sed -ne 's,^Version: *\(.*\)$$,\1,p')
VERSION_UPSTREAM := $(shell echo "$(VERSION_COMPLETE)" | sed -e 's,^[0-9]*:,,' -e 's,-[^-]*$$,,')
VERSION_DEBIAN := $(shell echo "$(VERSION_COMPLETE)" | sed -e 's,^[^-]*-,,')

DEVMAPPER_ABINAME = 1.02.1
DEVMAPPER_VERSION_PLAIN = 1.02.30
DEVMAPPER_VERSION = 2:$(DEVMAPPER_VERSION_PLAIN)
DEVMAPPER_VERSION_DEBIAN = $(DEVMAPPER_VERSION)-$(VERSION_DEBIAN)
DEVMAPPER_VERSION_FILE = $(DEVMAPPER_VERSION_PLAIN)-$(VERSION_DEBIAN)

BUILD_DIR = debian/build
STAMPS_DIR = debian/stamps

CFLAGS_UDEB := $(CFLAGS)
ifeq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
CFLAGS_UDEB = -g -Os
endif

CONFIGURE_FLAGS = --build $(DEB_BUILD_GNU_TYPE)
ifneq ($(DEB_HOST_GNU_TYPE),$(DEB_BUILD_GNU_TYPE))
CONFIGURE_FLAGS += --host $(DEB_HOST_GNU_TYPE)
endif

CONFIGURE_FLAGS += \
	--prefix=/usr \
	--exec-prefix= \
	--mandir=\$${prefix}/share/man \
	--infodir=\$${prefix}/share/info \
	--with-confdir=\$${exec_prefix}/etc

ifneq (,$(findstring $(DEB_HOST_ARCH), arm armeb hppa mips mipsel))
CONFIGURE_FLAGS += --disable-o_direct
endif

source: $(STAMPS_DIR)/source

$(STAMPS_DIR)/source: DIR = $(BUILD_DIR)/source
$(STAMPS_DIR)/source:
	@mkdir -p $(STAMPS_DIR)
	rm -rf $(DIR)
	mkdir -p $(DIR)
	cp -al $(filter-out debian .svk .svn, $(wildcard .[^.]* *)) $(DIR)
	cp --remove-destination /usr/share/misc/config.sub /usr/share/misc/config.guess $(DIR)/autoconf
	cd $(DIR); QUILT_PATCHES=$(CURDIR)/debian/patches quilt --quiltrc /dev/null push -a || test $$? = 2
	cd $(DIR); autoreconf
	touch $@

setup: $(STAMPS_DIR)/setup-deb $(STAMPS_DIR)/setup-udeb

$(STAMPS_DIR)/setup-deb: SOURCE_DIR = $(BUILD_DIR)/source
$(STAMPS_DIR)/setup-deb: DIR = $(BUILD_DIR)/build-deb
$(STAMPS_DIR)/setup-deb: $(STAMPS_DIR)/source
	rm -rf $(DIR)
	cp -al $(SOURCE_DIR) $(DIR)
	cd $(DIR); \
	./configure CFLAGS="$(CFLAGS)" \
		$(CONFIGURE_FLAGS) \
		--with-optimisation="" \
		--with-clvmd=cman \
		--with-device-uid=0 \
		--with-device-gid=6 \
		--with-device-mode=0660 \
		--enable-pkgconfig \
		--enable-readline
	touch $@

$(STAMPS_DIR)/setup-udeb: SOURCE_DIR = $(BUILD_DIR)/source
$(STAMPS_DIR)/setup-udeb: DIR = $(BUILD_DIR)/build-udeb
$(STAMPS_DIR)/setup-udeb: $(STAMPS_DIR)/source
	rm -rf $(DIR)
	cp -al $(SOURCE_DIR) $(DIR)
	cd $(DIR); \
	./configure CFLAGS="$(CFLAGS_UDEB)" \
		$(CONFIGURE_FLAGS) \
		--with-optimisation="" \
		--with-cluster=none \
		--with-lvm1=none \
		--with-pool=none \
		--disable-selinux \
		--disable-readline
	touch $@

build: $(STAMPS_DIR)/build-deb $(STAMPS_DIR)/build-udeb

build-deb: $(STAMPS_DIR)/build-deb
.NOTPARALLEL: $(STAMPS_DIR)/build-deb
$(STAMPS_DIR)/build-deb: DIR = $(BUILD_DIR)/build-deb
$(STAMPS_DIR)/build-deb: $(STAMPS_DIR)/setup-deb
	dh_testdir
	$(MAKE) -C $(DIR) LIB_VERSION_DM=$(DEVMAPPER_ABINAME)
	touch $@

build-udeb: $(STAMPS_DIR)/build-udeb
.NOTPARALLEL: $(STAMPS_DIR)/build-udeb
$(STAMPS_DIR)/build-udeb: DIR = $(BUILD_DIR)/build-udeb
$(STAMPS_DIR)/build-udeb: $(STAMPS_DIR)/setup-udeb
	dh_testdir
	$(MAKE) -C $(DIR) LIB_VERSION_DM=$(DEVMAPPER_ABINAME)
	touch $@

$(BUILD_DIR) $(STAMPS_DIR):
	@[ -d $@ ] || mkdir $@

maintainerclean:
	rm -rf $(filter-out .svn .svk debian, $(wildcard * .[^.]*))

clean:
	dh_testdir
	rm -rf $(BUILD_DIR) $(STAMPS_DIR)
	dh_clean

install: $(addprefix install-,libdevmapper libdevmapper-udeb dmsetup dmsetup-udeb lvm2 lvm2-udeb clvm)

install-base:
	dh_installdocs
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol -- $(GENCONTROL_ARGS)
	dh_md5sums
	dh_builddeb

install-clvm: export DH_OPTIONS = -pclvm
install-clvm: DIR = $(BUILD_DIR)/build-deb
install-clvm: INSTALL_DIR = $(BUILD_DIR)/install-clvm
install-clvm: $(STAMPS_DIR)/build-deb
	dh_testdir
	dh_testroot
	dh_clean -k
	$(MAKE) -C $(DIR) install DESTDIR=$(CURDIR)/$(INSTALL_DIR)
	dh_install --sourcedir=$(INSTALL_DIR)
	dh_installchangelogs WHATS_NEW
	dh_installexamples
	dh_installinit --no-start -- start 63 S . start 51 0 6 .
	$(MAKE) -f debian/rules install-base

install-dmsetup: export DH_OPTIONS = -pdmsetup
install-dmsetup: DIR = $(BUILD_DIR)/build-deb
install-dmsetup: INSTALL_DIR = $(BUILD_DIR)/install-dmsetup
install-dmsetup: $(STAMPS_DIR)/build-deb
	dh_testdir
	dh_testroot
	dh_clean -k
	$(MAKE) -C $(DIR) install DESTDIR=$(CURDIR)/$(INSTALL_DIR)
	dh_install --sourcedir=$(INSTALL_DIR)
	dh_installchangelogs WHATS_NEW_DM
	dh_installdebconf
	dh_installexamples
	dh_installudev --priority=65
	$(MAKE) -f debian/rules install-base GENCONTROL_ARGS="-v$(DEVMAPPER_VERSION_DEBIAN)"

install-dmsetup-udeb: PACKAGE_NAME = dmsetup-udeb
install-dmsetup-udeb: export DH_OPTIONS = -p$(PACKAGE_NAME)
install-dmsetup-udeb: PACKAGE_FILE = $(PACKAGE_NAME)_$(DEVMAPPER_VERSION_FILE)_$(DEB_HOST_ARCH).udeb
install-dmsetup-udeb: DIR = $(BUILD_DIR)/build-udeb
install-dmsetup-udeb: INSTALL_DIR = $(BUILD_DIR)/install-dmsetup-udeb
install-dmsetup-udeb: $(STAMPS_DIR)/build-udeb
	dh_testdir
	dh_testroot
	dh_clean -k
	$(MAKE) -C $(DIR) install DESTDIR=$(CURDIR)/$(INSTALL_DIR)
	dh_installchangelogs WHATS_NEW_DM
	dh_install --sourcedir=$(INSTALL_DIR)

	dh_installdocs
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dpkg-gencontrol \
		-p$(PACKAGE_NAME) -ldebian/changelog -n$(PACKAGE_FILE) \
		-Tdebian/$(PACKAGE_NAME).substvars -Pdebian/$(PACKAGE_NAME) \
		-v$(DEVMAPPER_VERSION_DEBIAN)
	dh_md5sums
	dpkg-deb --build debian/$(PACKAGE_NAME) ../$(PACKAGE_FILE)


install-libdevmapper: export DH_OPTIONS = -plibdevmapper-dev -plibdevmapper$(DEVMAPPER_ABINAME)
install-libdevmapper: DIR = $(BUILD_DIR)/build-deb
install-libdevmapper: INSTALL_DIR = $(BUILD_DIR)/install-libdevmapper
install-libdevmapper: $(STAMPS_DIR)/build-deb
	dh_testdir
	dh_testroot
	dh_clean -k
	$(MAKE) -C $(DIR) install DESTDIR=$(CURDIR)/$(INSTALL_DIR) LIB_VERSION_DM=$(DEVMAPPER_ABINAME)
	dh_install --sourcedir=$(INSTALL_DIR)
	dh_installchangelogs WHATS_NEW_DM
	dh_installexamples
	dh_link -p libdevmapper-dev lib/libdevmapper.so.$(DEVMAPPER_ABINAME) usr/lib/libdevmapper.so
	dh_makeshlibs -p 'libdevmapper$(DEVMAPPER_ABINAME)' \
		--add-udeb 'libdevmapper$(DEVMAPPER_ABINAME)-udeb' \
	       	"-Vlibdevmapper$(DEVMAPPER_ABINAME) (>= $(DEVMAPPER_VERSION))" \
		-- "-v$(DEVMAPPER_VERSION_DEBIAN)"
	$(MAKE) -f debian/rules install-base GENCONTROL_ARGS="-v$(DEVMAPPER_VERSION_DEBIAN)"

install-libdevmapper-udeb: PACKAGE_NAME = libdevmapper$(DEVMAPPER_ABINAME)-udeb
install-libdevmapper-udeb: export DH_OPTIONS = -p$(PACKAGE_NAME)
install-libdevmapper-udeb: PACKAGE_FILE = $(PACKAGE_NAME)_$(DEVMAPPER_VERSION_FILE)_$(DEB_HOST_ARCH).udeb
install-libdevmapper-udeb: DIR = $(BUILD_DIR)/build-udeb
install-libdevmapper-udeb: INSTALL_DIR = $(BUILD_DIR)/install-libdevmapper-udeb
install-libdevmapper-udeb: $(STAMPS_DIR)/build-udeb
	dh_testdir
	dh_testroot
	dh_clean -k
	$(MAKE) -C $(DIR) install DESTDIR=$(CURDIR)/$(INSTALL_DIR) LIB_VERSION_DM=$(DEVMAPPER_ABINAME)
	dh_install --sourcedir=$(INSTALL_DIR)
	dh_installchangelogs WHATS_NEW_DM
	dh_installexamples

	dh_installdocs
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dpkg-gencontrol \
		-p$(PACKAGE_NAME) -ldebian/changelog -n$(PACKAGE_FILE) \
		-Tdebian/$(PACKAGE_NAME).substvars -Pdebian/$(PACKAGE_NAME) \
		-v$(DEVMAPPER_VERSION_DEBIAN)
	dh_md5sums
	dpkg-deb --build debian/$(PACKAGE_NAME) ../$(PACKAGE_FILE)

install-lvm2: export DH_OPTIONS = -plvm2
install-lvm2: DIR = $(BUILD_DIR)/build-deb
install-lvm2: INSTALL_DIR = $(BUILD_DIR)/install-lvm2
install-lvm2: $(STAMPS_DIR)/build-deb
	dh_testdir
	dh_testroot
	dh_clean -k
	$(MAKE) -C $(DIR) install DESTDIR=$(CURDIR)/$(INSTALL_DIR)
	dh_install --sourcedir=$(INSTALL_DIR)
	cp -a debian/initramfs-tools debian/lvm2/usr/share
	chmod +x -R debian/lvm2/usr/share/initramfs-tools
	dh_installchangelogs WHATS_NEW
	dh_installdebconf
	dh_installexamples
	dh_installinit --no-start -- start 26 S . start 50 0 6 .
	$(MAKE) -f debian/rules install-base

install-lvm2-udeb: export DH_OPTIONS = -plvm2-udeb
install-lvm2-udeb: DIR = $(BUILD_DIR)/build-udeb
install-lvm2-udeb: INSTALL_DIR = $(BUILD_DIR)/install-lvm2-udeb
install-lvm2-udeb: $(STAMPS_DIR)/build-udeb
	dh_testdir
	dh_testroot
	dh_clean -k
	$(MAKE) -C $(DIR) install DESTDIR=$(CURDIR)/$(INSTALL_DIR)
	dh_installchangelogs WHATS_NEW
	dh_install --sourcedir=$(INSTALL_DIR)
	$(MAKE) -f debian/rules install-base

binary-indep:
binary-arch: install

binary: binary-indep binary-arch

DIR_ORIG = ../orig/$(SOURCE)-$(VERSION_UPSTREAM)
TAR_ORIG_NAME = $(SOURCE)_$(VERSION_UPSTREAM).orig.tar.gz
TAR_ORIG = $(firstword $(wildcard ../$(TAR_ORIG_NAME)) $(wildcard ../orig/$(TAR_ORIG_NAME)))

orig: $(DIR_ORIG)
	rsync --delete --exclude debian --exclude .svk --exclude .svn --link-dest=$(DIR_ORIG)/ -a $(DIR_ORIG)/ .

$(DIR_ORIG):
ifeq ($(TAR_ORIG),)
	$(error Cannot find orig tarball $(TAR_ORIG_NAME))
else
	mkdir -p ../orig
	tar -C ../orig -xzf $(TAR_ORIG)
endif

.PHONY: build clean binary-indep binary-arch binary install configure
